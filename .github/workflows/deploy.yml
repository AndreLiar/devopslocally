name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Test & Security Scan"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Services
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'
      
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Verify cluster connection
        run: kubectl cluster-info
      
      - name: Request deployment approval
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const approval = {
              status: 'pending',
              deployment: 'auth-service',
              timestamp: new Date().toISOString(),
              commit: '${{ github.sha }}'
            };
            console.log('Deployment approval required:', JSON.stringify(approval, null, 2));
      
      - name: Deploy auth-service
        run: |
          helm repo add myrepo file://$(pwd)/auth-chart || true
          helm upgrade --install auth-service auth-chart/ \
            --namespace default \
            --values auth-chart/values.yaml \
            --set image.tag=sha-${{ github.sha }} \
            --wait \
            --timeout 5m
      
      - name: Run smoke tests
        run: |
          # Wait for deployment to be ready
          kubectl rollout status deployment/auth-service -n default --timeout=5m
          
          # Get service endpoint
          SERVICE_IP=$(kubectl get svc auth-service -n default -o jsonpath='{.spec.clusterIP}')
          
          # Test health endpoint
          for i in {1..5}; do
            echo "Health check attempt $i..."
            if kubectl run -i --rm debug --image=curlimages/curl:latest --restart=Never -- \
               curl -s -f http://$SERVICE_IP:3000/health; then
              echo "✓ Health check passed"
              exit 0
            fi
            sleep 10
          done
          exit 1
      
      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? '✅' : '❌';
            const message = `${statusEmoji} Deployment ${status}: auth-service deployed to production`;
            console.log(message);
            // In production, send to Slack webhook or similar
            console.log('Deployment Status: ' + JSON.stringify({
              status: status,
              deployment: 'auth-service',
              commit: '${{ github.sha }}',
              branch: '${{ github.ref }}',
              timestamp: new Date().toISOString()
            }, null, 2));
      
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/auth-service -n default --timeout=2m
          kubectl get pods -n default
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          kubectl port-forward -n default svc/auth-service 3000:3000 &
          sleep 2
          curl -s http://localhost:3000/ || echo "Service not yet available"

  notify:
    name: Notify on Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Create Slack notification
        if: needs.deploy.result == 'success'
        run: |
          echo "✅ Deployment successful: ${{ github.event.workflow_run.head_commit.message || github.sha }}"
      
      - name: Deployment failed notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "❌ Deployment failed. Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
