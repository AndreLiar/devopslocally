name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Test & Security Scan"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Services
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'
      
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        if: secrets.KUBE_CONFIG != ''
      
      - name: Verify cluster connection
        run: kubectl cluster-info
        if: secrets.KUBE_CONFIG != ''
      
      - name: Deploy auth-service
        run: |
          helm repo add myrepo file://$(pwd)/auth-chart || true
          helm upgrade --install auth-service auth-chart/ \
            --namespace default \
            --values auth-chart/values.yaml \
            --set image.tag=sha-${{ github.sha }} \
            --wait \
            --timeout 5m
        if: secrets.KUBE_CONFIG != ''
      
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/auth-service -n default --timeout=2m
          kubectl get pods -n default
        if: secrets.KUBE_CONFIG != ''
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          kubectl port-forward -n default svc/auth-service 3000:3000 &
          sleep 2
          curl -s http://localhost:3000/ || echo "Service not yet available"
        if: secrets.KUBE_CONFIG != ''

  notify:
    name: Notify on Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Create Slack notification
        if: needs.deploy.result == 'success'
        run: |
          echo "✅ Deployment successful: ${{ github.event.head_commit.message }}"
      
      - name: Deployment failed notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "❌ Deployment failed. Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
